drop table if exists dwh.order_detales_fact;

CREATE TABLE dwh.order_detales_fact
(
	 row_key        int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	 row_id			int not null, 
	 order_id       varchar(15) NOT NULL,
	 ship_date_key  date NOT NULL,
	 customer_key   int NOT NULL,	
	 order_date_key date NOT NULL,
	 product_key    int NOT NULL,
	 ship_mode      varchar NOT NULL,
	 sales_name     varchar NOT NULL,
	 returned       boolean NOT NULL,
	 sales          decimal(18,2) NOT NULL,
	 quantity       int NOT NULL,
	 discount       decimal(3,2) NOT NULL,
	 profit         decimal(18,2) NOT NULL,
	 country        varchar NOT NULL,
	 "state"        varchar NOT NULL,
	 city			varchar NOT NULL,
	 postal_code    varchar(50),
	 region         varchar(50) NOT NULL,
	 CONSTRAINT FK_1 FOREIGN KEY ( product_key ) REFERENCES product_dim ( product_key ),
	 CONSTRAINT FK_2 FOREIGN KEY ( order_date_key ) REFERENCES date_dim ( "date" ),
	 CONSTRAINT FK_3 FOREIGN KEY ( customer_key ) REFERENCES customer_dim ( customer_key ),
	 CONSTRAINT FK_4 FOREIGN KEY ( ship_date_key ) REFERENCES date_dim ( "date" )
);

CREATE INDEX FK_2 ON dwh.order_detales_fact
(
 	product_key
);

CREATE INDEX FK_3 ON dwh.order_detales_fact
(
 	order_date_key
);

CREATE INDEX FK_4 ON dwh.order_detales_fact
(
 	customer_key
);

CREATE INDEX FK_5 ON dwh.order_detales_fact
(
 	ship_date_key
);


INSERT INTO dwh.order_detales_fact(
	row_id, 
	order_id, 
	ship_date_key, 
	customer_key, 
	order_date_key, 
	product_key, 
	ship_mode, 
	sales_name, 
	returned, 
	sales, 
	quantity, 
	discount, 
	profit, 
	country, 
	state,
	city,
	postal_code, 
	region)
SELECT 
	o.row_id, 
	o.order_id,
	o.ship_date,
	c.customer_key, 
	o.order_date,
	p.product_key, 
	o.ship_mode,
	s.person,
	case 
		when r.returned is null then
			false
		else
			true
	end,
	o.sales, 
	o.quantity, 
	o.discount, 
	o.profit, 
	o.country,
	o.state, 
	o.city, 
	o.postal_code, 
	o.region
FROM public.orders o left join dwh.customer_dim c on o.customer_id = c.customer_id 
	left join dwh.product_dim p on o.product_id = p.product_id and o.product_name = p.product_name
	left join public.people s on o.region = s.region
	left join (
		select distinct 
			*
		from public."returns") r on o.order_id = r.order_id ;
	
	
select 
	*
from dwh.order_detales_fact odf; 





















